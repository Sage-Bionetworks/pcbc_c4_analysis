Quality Control Filtering and Normalization of methylation C4 data
===================================================================

Load the necessary libraries 
```{r, message=FALSE, warning=FALSE} 
library(minfi)
library(lumi)
library(rGithubClient)

library(synapseClient)
synapseLogin()

METHYLATIONMETA_ID <-'syn3156828'
```

### Find and download all of the idat files in Synapse 
```{r downloadChunk, cache=TRUE}
fileList <- synQuery('select id, name,C4_Cell_Line_ID,Diffname_short,BeadChip,Array_position,Row,Column,UID from file where parentId=="syn2653626" and fileType=="idat"')
colnames(fileList) <- gsub("file\\.", "", colnames(fileList))

dataDir <- getwd()
files <- lapply(fileList$id, 
                function (x) synGet(x, downloadLocation=dataDir))
```

Load the methylation data
```{r readChunk, cache=TRUE, dependson="downloadChunk"}
RGSet <- read.450k.exp(base = dataDir)
```

Add the metadata (TEMP FIX)
```{r}
# metaTable <- synTableQuery(sprintf("select * from %s", METHYLATIONMETA_ID))
# metaTbl <- metaTable@values
fileList$prettyName <- gsub("_Red.*", "", fileList$name, perl=TRUE)
fileList$prettyName <- gsub("_Grn.*", "", fileList$prettyName, perl=TRUE)

metaTbl <- fileList
metaTbl$name <- NULL
metaTbl$id <- NULL
metaTbl  <- unique(metaTbl)

CELLMETA_ID <- "syn2767694"
cellTable <- synTableQuery(sprintf("select * from %s", CELLMETA_ID))
cellTbl <- cellTable@values

meta <- merge(metaTbl, cellTbl, by="C4_Cell_Line_ID")
rownames(meta) <- meta$prettyName

idx <- match(colnames(RGSet), rownames(meta))
pData(RGSet)<-meta[idx,]
meta <- pData(RGSet)
```


Filter out the data sets that are not public and remove poor quality cell-lines.  Specicically SC12-040 has a problematic karyotype.
```{r filterChunk, cache=TRUE, dependson="downloadChunk"}
idx = (pData(RGSet)$public) & (pData(RGSet)$C4_Cell_Line_ID!='SC12-040')
RGSet <- RGSet[,idx]
```

### Compute methylated signals and observe the sample qualities
```{r plot_qualityChunk, fig.width=7, fig.height=6, cache=TRUE, dependson="filterChunk"}
MSet <- preprocessRaw(RGSet)
#Plot quality for datasets
qc <- getQC(MSet)
plotQC(qc)

#look at detection level per sample
detP <- detectionP(RGSet)
failed <- detP > 0.01
plot(as.factor(pData(RGSet)$Array), colMeans(failed), main='Mean Failure Rate per Sample', xlab='Array', ylab='mean # of probes with detection p value >0.01')
```

There are `r sum(rowMeans(failed)>0.05)` probes with detection p value >0.01 in >5% of samples.  Also it is clear that array 6264488096 has issues along with other samples.

### Perform quantile normalization and filter out these samples with low qc metrics.
```{r normalizeChunk, cache=TRUE, dependson="filterChunk"}
pData(RGSet)$sex <- ifelse(pData(RGSet)$Gender == "male", "M", "F")
gRatioSet.quantile <- preprocessQuantile(RGSet, fixOutliers = TRUE,
                                         removeBadSamples = TRUE,
                                         badSampleCutoff = 10.5,
                                         quantileNormalize = TRUE,
                                         stratified = TRUE,
                                         mergeManifest = FALSE, 
                                         sex = NULL)

beta <- getBeta(gRatioSet.quantile)
```

These samples were removed:

```{r, echo=FALSE}
removed <- setdiff(colnames(RGSet), colnames(gRatioSet.quantile))

printCols <- c("UID", "C4_Cell_Line_ID", "Diffname_short")

pData(RGSet)[removed, printCols]
```

### Review the quality of the normalized data with PCA and clustering
```{r, fig.width=9}
#sub-sample the large matrix
smaller <-beta[sample(nrow(gRatioSet.quantile),10000), ]
#Perform PCA and plot color based on 
plotSampleRelation(smaller, method='mds', cv.Th=0, color=pData(gRatioSet.quantile)$Diffname.short)
plotSampleRelation(smaller, method='cluster', cv.Th=0, cex=.9)
#The second PC corresponds to gender
plotSampleRelation(smaller, method='mds', cv.Th=0, color=as.character(pData(gRatioSet.quantile)$Gender), dimension=c(2,3))
#The third PC is somewhat related to lab of origin
plotSampleRelation(smaller, method='mds', cv.Th=0, color=as.character(pData(gRatioSet.quantile)$originating.lab), dimension=c(3,4))
```

### Store the normalized dataset in Synapse

```{r}
repo <- getRepo("kdaily/pcbc_c4_analysis", ref="branch", refName="methylation")
script <- getPermlink(repo, "code/Rmd/normalize_methylation.Rmd")

write.table(beta, file='C4Meth450.tsv', col.names=NA,  sep='\t')
file <- File('C4Meth450.tsv', parentId='syn2813225', name='Normalized methylation calls')
synSetAnnotations(file) <- list(dataType="methylation")

usedFiles <- subset(fileList, prettyName %in% sampleNames(RGSet))
act <- Activity(name="Normalize", 
                description="Normalize methylation using minfi and lumi", 
                used=usedFiles$id, executed=(script))
generatedBy(file) <- act
data <- synStore(file)
```
