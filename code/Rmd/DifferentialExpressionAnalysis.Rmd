---
title: "Differential Expression Analysis"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---
  
```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
## It is assumed your working directory is where this file is
# Load required libraries
library('synapseClient')
library('limma')
library('edgeR')
library('goseq')
library('stringr')
library('knitr')
library('plyr')

## Requires ggdendro
devtools::source_url("https://raw.githubusercontent.com/chr1swallace/random-functions/master/R/ggplot-heatmap.R")

# devtools::source_gist('2866ef5c0aeb64d265ed')
# knit2synapse(file = "./DifferentialExpressionAnalysis.Rmd", owner = 'syn3537209', wikiName = "Differential Expression Analysis",overwrite=T)

synapseLogin()

# source utility files from ../R/lib folder
file.sources = list.files('../R/lib',pattern="*.R")
file.sources = sapply(file.sources,function(x){return(paste('../R/lib',x,sep='/'))})
tmp = sapply(file.sources,source,.GlobalEnv)

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE)
```

```{r setup}
# Input Parameters
DESIGN_ID = 'syn3471933';
EXPR_ID = 'syn3471917';
WEIGHTS_ID = 'syn3471926';

SYNAPSE_STORE = T;
parentId = 'syn3471223';
```
Synapse id of design, expression, weights and metadata matrix used for the analysis are `r DESIGN_ID`,`r EXPR_ID`,`r WEIGHTS_ID`

Obtain data from synapse.
```{r getdata, cache=TRUE}
# Get design matrix
DESIGN_OBJ = synGet(DESIGN_ID);
ALL_USED_IDs = c(DESIGN_OBJ$properties$id);
DESIGN = read.table(getFileLocation(DESIGN_OBJ),sep='\t',header=T,row.names=1, check.names=FALSE)
colnames(DESIGN) = gsub("[[:punct:]]", "_",colnames(DESIGN))

# Get expression matrix
EXPR_OBJ = synGet(EXPR_ID);
ALL_USED_IDs = c(ALL_USED_IDs,EXPR_OBJ$properties$id);
EXPR = read.table(getFileLocation(EXPR_OBJ),sep='\t',header=T,row.names=1, check.names=FALSE)

# Get weighting matrix
WEIGHTS_OBJ = synGet(WEIGHTS_ID);
ALL_USED_IDs = c(ALL_USED_IDs,WEIGHTS_OBJ$properties$id);
WEIGHTS = read.table(getFileLocation(WEIGHTS_OBJ),sep='\t',header=T,row.names=1, check.names=FALSE)
```

Get differentially expressed genes using limma package with following co-efficients `r colnames(DESIGN)` in linear model

Differential expression of differentiation stages (Male&Female vs Male only vs Female only analysis)
```{r diffstate, cache=TRUE}
Gender <- c('all','male','female')
DIFF.EXP.DIFFNAME <- list()
for(gend in Gender){
  if(gend == 'all'){
    ind <- colnames(EXPR) %in% rownames(DESIGN)
    FIT <- lmFit(EXPR[,ind], design = DESIGN[ind,], weights = WEIGHTS[,ind])
  } else {
    ind <- colnames(EXPR) %in% rownames(DESIGN[DESIGN[,paste('Gender',gend,sep='')] == 1,])
    FIT <- lmFit(EXPR[,ind], design = DESIGN[ind,-(grep('Gender',colnames(DESIGN)))], weights = WEIGHTS[,ind])
  }
                
  # Make contrast to check differential expression between different differentiation stages
  CONT.NAMES <- colnames(DESIGN)[grep('Diffname_short',colnames(DESIGN))]
  CONT.NAMES <- combn(CONT.NAMES,2)
  CONT.NAMES <- apply(CONT.NAMES,2,paste,collapse='-')
  
  CONT <- makeContrasts(contrasts=CONT.NAMES,levels=colnames(FIT$coefficients))
  
  # Refit contrasts
  FIT.DIFFNAME <- contrasts.fit(FIT,CONT)
  
  # Estimate moderated t-statistics
  FIT.DIFFNAME <- eBayes(FIT.DIFFNAME)
  
  # Obtain all the differential expession combinations
  DIFF.EXP.DIFFNAME[[gend]] <- list()
  DIFF.EXP.DIFFNAME[[gend]]$logFC <- data.frame(row.names = rownames(EXPR))
  DIFF.EXP.DIFFNAME[[gend]]$adj.P.Val <- data.frame(row.names = rownames(EXPR))
  
  for (i in CONT.NAMES){
    tmp <- topTable(FIT.DIFFNAME, coef=i, number=dim(EXPR)[1])    
    DIFF.EXP.DIFFNAME[[gend]]$logFC[,str_replace_all(i,"Diffname_short","")] <- tmp[rownames(DIFF.EXP.DIFFNAME[[gend]]$logFC),'logFC']
    DIFF.EXP.DIFFNAME[[gend]]$adj.P.Val[,str_replace_all(i,"Diffname_short","")] <- tmp[rownames(DIFF.EXP.DIFFNAME[[gend]]$adj.P.Val),'adj.P.Val']
  }
  
  # Get number of significantly differentialy expressed genes with adj.P.Val <= 0.001 and abs(logFC) >= 2
  DIFF.EXP.DIFFNAME[[gend]]$SIG.EXP <- DIFF.EXP.DIFFNAME[[gend]]$adj.P.Val<=0.001 & abs(DIFF.EXP.DIFFNAME[[gend]]$logFC) >= 2  
}
```

Find number of differentially expressed genes
```{r significant.sets,cache=TRUE}
# Get number of significant sets
numSigSets.x <- function(x,DIFF.EXP.DIFFNAME){
  numSigSets.xy <- function(y,DIFF.EXP.DIFFNAME,x){
    return(sum(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP[,y]))
  }  
  return(sapply(colnames(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP),numSigSets.xy,DIFF.EXP.DIFFNAME,x))
}
NUM.SIG.SETS <- as.data.frame(sapply(names(DIFF.EXP.DIFFNAME),numSigSets.x,DIFF.EXP.DIFFNAME))

# Get intersection and difference of gene specific to male and female
for (j in rownames(NUM.SIG.SETS)){
  NUM.SIG.SETS[j,'common'] <- sum(DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,j] & DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,j])
  NUM.SIG.SETS[j,'male.only'] <- sum(DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,j] & !DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,j])
  NUM.SIG.SETS[j,'female.only'] <- sum(!DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,j] & DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,j])
}
kable(NUM.SIG.SETS)
```

Find number of differentially expressed genes that are specific to each contrasts

```{r specific.significant.sets,cache=TRUE}
# Get number of significant sets (specific only to that contrast)
numSigSets.x <- function(x,DIFF.EXP.DIFFNAME){
  numSigSets.xy <- function(y,DIFF.EXP.DIFFNAME,x){
    return(sum(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP[,y] & rowSums(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP[,-(grep(y,colnames(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP)))])==0))
  }  
  return(sapply(colnames(DIFF.EXP.DIFFNAME[[x]]$SIG.EXP),numSigSets.xy,DIFF.EXP.DIFFNAME,x))
}
NUM.SPEC.SIG.SETS <- sapply(names(DIFF.EXP.DIFFNAME),numSigSets.x,DIFF.EXP.DIFFNAME)
kable(NUM.SPEC.SIG.SETS)
```

Perform enrichment analysis

```{r enrichment.analysis}
# GO.Analysis.x <- function(x,DIFF.EXP.DIFFNAME){
#   
#   GO.Analysis.xy <- function(y,DIFF.EXP.DIFFNAME,x){
#     allGenes <- switch(x, all = DIFF.EXP.DIFFNAME[['all']]$SIG.EXP[,y], male = DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,y],
#                        female = DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,y],
#                        common = DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,y] & DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,y],
#                        male.only = DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,y] & !DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,y],
#                        female.only = !DIFF.EXP.DIFFNAME[['male']]$SIG.EXP[,y] & DIFF.EXP.DIFFNAME[['female']]$SIG.EXP[,y])
#     names(allGenes) <- sapply(names(allGenes),function(x){strsplit(x,'\\.')[[1]][1]})
#     
#     # Calculate probability weighting function based on length of gene
#     pwf = nullp(allGenes, 'hg19', 'ensGene',plot.fit=F)
#     
#     # Calculate go enrichment using Wallenius method    
#     GO.wall = goseq(pwf, 'hg19', 'ensGene', method = "Wallenius")
#     GO.wall$over_represented_adj_pvalue = p.adjust(GO.wall$over_represented_pvalue, method = 'bonferroni')
#     GO.wall$under_represented_adj_pvalue = p.adjust(GO.wall$under_represented_pvalue, method = 'bonferroni')
#     
#     return(list(y=GO.wall))
#     }
# GO.wall <- sapply(colnames(DIFF.EXP.DIFFNAME$all$SIG.EXP),GO.Analysis.xy,DIFF.EXP.DIFFNAME,x)
# return(list(x=GO.wall))
# }
# GO.Annotations <- sapply(c('all', 'male', 'female', 'common', 'male.only', 'female.only'),GO.Analysis.x,DIFF.EXP.DIFFNAME)
```

Store files in synapse
 
```{r synapse.store}
if(SYNAPSE_STORE){
  CODE <- File('./DifferentialExpressionAnalysis.Rmd',name = 'Differential Expression Analysis',parentId = parentId)
  CODE <- synStore(CODE, used =ALL_USED_IDs,activityName='Differential Expression Analysis', executed='https://github.com/th1vairam/pcbc_c4_analysis/blob/diff_exp/code/Rmd/DifferentialExpressionAnalysis.Rmd')
  
  for (i in names(DIFF.EXP.DIFFNAME)){
    colnames(DIFF.EXP.DIFFNAME[[i]]$logFC) <- paste(colnames(DIFF.EXP.DIFFNAME[[i]]$logFC),'_logFC',sep='')
    DIFF.EXP.DIFFNAME[[i]]$logFC$Genes <- str_replace_all(rownames(DIFF.EXP.DIFFNAME[[i]]$logFC),'\\..*','')
    
    colnames(DIFF.EXP.DIFFNAME[[i]]$adj.P.Val) <- paste(colnames(DIFF.EXP.DIFFNAME[[i]]$adj.P.Val),'_adjPval',sep='')
    DIFF.EXP.DIFFNAME[[i]]$adj.P.Val$Genes <- str_replace_all(rownames(DIFF.EXP.DIFFNAME[[i]]$adj.P.Val),'\\..*','')
    
    tmp <- join_all(DIFF.EXP.DIFFNAME[[i]][c('logFC','adj.P.Val')],by='Genes',match='all')
    tmp <- tmp[,sort(colnames(tmp))]; tmp <- tmp[,c('Genes',setdiff(colnames(tmp),'Genes'))]
    
    write.table(tmp,file=paste('./DifferentialExpressionResults_',i,'.tsv',sep=''),sep='\t',quote=F,row.names=F)
    RESULT <- File(paste('./DifferentialExpressionResults_',i,'.tsv',sep=''),name = paste('Differential Expression Results',i,sep=' '),parentId = parentId)
    RESULT <- synStore(RESULT, used = ALL_USED_IDs, activityName='Covariate Analysis', executed=CODE$properties$id)
  }  
}
```