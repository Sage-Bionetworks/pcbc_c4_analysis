---
title: "Covariate Analysis"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---

```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
## It is assumed your working directory is where this file is
# Load required libraries
library('synapseClient')
library('limma')
library('edgeR')
library('RColorBrewer')
library('ctv')
library('ggplot2')
library('psych')
library('reshape2')
library('gplots')
library('vcd')
library('psych')
library('erer')
library('fpc')

## Requires ggdendro
devtools::source_url("https://raw.githubusercontent.com/chr1swallace/random-functions/master/R/ggplot-heatmap.R")

# source('/mnt/Github/Knit2Synapse/knit2synapse.R')
# knit2synapse(file = "./CovariateAnalysis.Rmd", owner = 'syn3382512', wikiName = "Covariate Analysis",overwrite=F)

synapseLogin()

# source utility files from ../R/lib folder
file.sources = list.files('../R/lib',pattern="*.R")
file.sources = sapply(file.sources,function(x){return(paste('../R/lib',x,sep='/'))})
tmp = sapply(file.sources,source,.GlobalEnv)

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE)
```

```{r setup}
# Input Parameters
COUNT_ID = 'syn3164570';
METADATA_ID = 'syn3156503';
OUTLIERS_ID = 'NULL';

SYNAPSE_STORE = T;
parentId = 'syn3276099';

# Specify factor and continuous covarites pool (adjusted covariates will only be the subset of these covariates)
FactorCovariates = c('Diffname_short','run','lane','index','Cell_Type_of_Origin', 'Cell_Line_of_Origin', 'Tissue_of_Origin', 'Reprogramming_Vector_Type','Reprogramming_Gene_Combination', 'Donor_Life_Stage','Originating_Lab','Gender','Donor_ID','Disease','Race','Ethnicity','Cell_Line_Type')
ContCovariates = c()
```
Synapse id of count matrix used for the analysis is `r COUNT_ID` and the synapse id of meta data table used for the analysis is `r METADATA_ID`. Outliers were extracted from `r OUTLIERS_ID`

Factor covariates considered for analysis are `r FactorCovariates`, and continuous covariates considered for the analysis are `r ContCovariates`.

Obtain count matrix and metadata from synapse.
```{r getdata, cache=TRUE}
# Get count matrix
COUNT_OBJ = synGet(COUNT_ID);
ALL_USED_IDs = COUNT_OBJ$properties$id;
COUNT = read.table(getFileLocation(COUNT_OBJ),sep='\t',header=T,row.names=1, check.names=FALSE)

# Get metadata
METADATA_OBJ = synTableQuery(paste('SELECT * FROM',METADATA_ID,sep=' '))
ALL_USED_IDs[length(ALL_USED_IDs)+1] = METADATA_OBJ@schema;
METADATA = METADATA_OBJ@values
```

Preprocess counts matrix and metadata 
```{r preprocessing}
# Preprocess metadata
METADATA[METADATA == 'N/A'] = 'Not Applicable'

# Assign new values for MESO-5, 15 and 30 samples
METADATA$Diffname_short[METADATA$Diffname_short == 'MESO-5'] = 'MESO_EARLY'
METADATA$Diffname_short[METADATA$Diffname_short == 'MESO-15' | METADATA$Diffname_short == 'MESO-30'] = 'MESO_LATE'

# Arrange count and metadata
RowsPresent = match(colnames(COUNT), METADATA$UID);
METADATA = METADATA[RowsPresent,]
rownames(METADATA) = METADATA$UID

#### Pre processing mRNA expression counts and metadata ####
# Remove somatic samples and samples with type NA
ind = METADATA$Cell_Type == "PSC" & !is.na(METADATA$Cell_Type)
COUNT = COUNT[,ind]
METADATA = METADATA[ind,]

# Remove samples that failed QC and samples classified as bad_lines
ind <- which(!METADATA$pass_qc | METADATA$exclude)

# Remove samples with abnormal karyotypes
ind = unique(c(ind, which(METADATA$C4_Karyotype_Result == "abnormal" | is.na(METADATA$C4_Karyotype_Result))))

REMOVED_UID <- METADATA$UID[ind]

COUNT <- COUNT[,-(ind)]
METADATA <- METADATA[-(ind),]
```
Following samples `r length(REMOVED_UID)` were removed `r REMOVED_UID` 

### Normalisation
Determine design matrix for normalisation and differential expression analysis. 

Remove genes that have less than 1 cpm counts in at least 50% of each of the individual differentiation stages.
```{r cpmnormalisation}
tmp <- tapply(colnames(COUNT),factor(METADATA$Diffname_short),function(cols,COUNT){PROCESSED_COUNTS = getGeneFilteredGeneExprMatrix(COUNT[,cols])},COUNT)
ugenes <- c()
for (i in unique(METADATA$Diffname_short))
  ugenes <- unique(c(ugenes,tmp[[i]]$filteredExprMatrix$genes[,1]))

COUNT <- COUNT[ugenes,,drop=F]
PROCESSED_COUNTS = getGeneFilteredGeneExprMatrix(COUNT,MIN_GENE_CPM=0,MIN_SAMPLE_PERCENT_WITH_MIN_GENE_CPM=0)
```

### Covariate clustering
Determine relationship between covariates. 

```{r covariates.clustering, fig.width=12, fig.height=10}
# Find inter relation between factor covariates
COVARIATES = METADATA[,c(FactorCovariates,ContCovariates)]

# Convert factor to numeric matrix 
COVARIATES[,FactorCovariates] = apply(COVARIATES[,FactorCovariates],2,function(cols){cols=as.numeric(unclass(factor(cols)))})
```

### Covariate correlation

```{r covariates.correlation, fig.width=12, fig.height=10}
COVARIATES.CORRELATION = getAssociationStatistics(COVARIATES,FactorCovariates,ContCovariates,PVAL=1)
ggheatmap.show(COVARIATES.CORRELATION$plot, col.width=0.3, row.width=0.15)
```
Some relationship between covariates

```{r covariates.relation}
ggMosaicPlot(factor(METADATA$Originating_Lab),factor(METADATA$Donor_ID))

ggMosaicPlot(factor(METADATA$Cell_Type_of_Origin),factor(METADATA$Tissue_of_Origin))

ggMosaicPlot(factor(METADATA$Donor_Life_Stage),factor(METADATA$Tissue_of_Origin))

ggMosaicPlot(factor(METADATA$Reprogramming_Gene_Combination),factor(METADATA$Reprogramming_Vector_Type))
```

Initial normalisation usign voom (with NULL design)

```{r initial.voom.normalisation}
VOOM.GENE_EXPRESSION = voom(PROCESSED_COUNTS$filteredExprMatrix, design=NULL, plot=T)

# Find PC of gene expression and significant covariates that are highly correlated with PCs
DM = getDesignMatrix(METADATA[,c(FactorCovariates,ContCovariates)],FactorCovariates,Intercept = F)
```

Correlation between pca of unadjusted mRNA expression and covariates is used to find significant covariates

```{r preAdjusted.covariates}
preAdjustedSigCovars = runPCAandPlotCorrelations(VOOM.GENE_EXPRESSION$E, DM$design,'NULL design(voom-normalized)', isKeyPlot=TRUE)

# Find significant covariates
adjustCovars = designMatVarsToCovars(getCovariatesMap(DM),preAdjustedSigCovars$significantCovars)
```

Significant covariates to adjust at FDR 0.1 are `r adjustCovars`

```{r preAdjustedSigCovars.NULL, fig.width=20, fig.height=10}
preAdjustedSigCovars[["PC_res"]][[1]]$plotData
```

```{r preAdjustedSigCovars.NULL.ALL, fig.width=20, fig.height=10}
preAdjustedSigCovars[["PC_res"]][[2]]$plotData
```

Since lot of covariates are confounded, re-normalising COVARIATES with a recursive design matrix.

```{r recurssive.adjusted.voom.normalisation}
postAdjustCovars = designMatVarsToCovars(getCovariatesMap(DM),names(preAdjustedSigCovars$Effects.significantCovars)[1])
residualSigCovars = preAdjustedSigCovars 
while (length(residualSigCovars$significantCovars) != 0){
  print(paste('Using following covariates in the model',paste(postAdjustCovars,collapse=','),sep=':'))
  
  # Post adjusted design matrix
  DM1 = getDesignMatrix(METADATA[,postAdjustCovars,drop=F],FactorCovariates,Intercept = F)
  
  VOOM.ADJUSTED.GENE_EXPRESSION = voom(PROCESSED_COUNTS$filteredExprMatrix, design=DM1$design, plot=T)
  
  # Residuals after normalisation
  RESIDUAL.GENE_EXPRESSION = calcResiduals(VOOM.ADJUSTED.GENE_EXPRESSION$E, DM1$design,sampleWeights = VOOM.ADJUSTED.GENE_EXPRESSION$weights)
  
  # Residual covariates to choose from
  DM1 = getDesignMatrix(METADATA[,setdiff(c(FactorCovariates,ContCovariates),postAdjustCovars)],FactorCovariates,Intercept = F)
    
  # Find PC of residual gene expression and significant covariates that are highly correlated with PCs
  residualSigCovars = runPCAandPlotCorrelations(RESIDUAL.GENE_EXPRESSION, DM1$design,'all adjusted design(voom-normalized)',isKeyPlot=TRUE)
  
  # Add postadjusted covariates (if any)
  postAdjustCovars = unique(c(postAdjustCovars,designMatVarsToCovars(getCovariatesMap(DM1),names(residualSigCovars$Effects.significantCovars)[1])))
}
```

Significant covariates to adjust at FDR 0.1 after considering confounding effects are `r postAdjustCovars`

```{r adjusted.voom.normalisation}
# Post adjusted design matrix
DM1 = getDesignMatrix(METADATA[,postAdjustCovars,drop=F],FactorCovariates,Intercept = F)

VOOM.ADJUSTED.GENE_EXPRESSION = voom(PROCESSED_COUNTS$filteredExprMatrix, design=DM1$design, plot=T)  
```

Sanity check: Residualise significant covariates using a linear model and find correlation between PCA of residuals with covariates

```{r calculate.residuals}
# Residuals after normalisation
RESIDUAL.GENE_EXPRESSION = calcResiduals(VOOM.ADJUSTED.GENE_EXPRESSION$E, DM1$design, sampleWeights = VOOM.ADJUSTED.GENE_EXPRESSION$weights)

# Find PC of residual gene expression and significant covariates that are highly correlated with PCs
residualSigCovars = runPCAandPlotCorrelations(RESIDUAL.GENE_EXPRESSION, DM$design,'residual matrix of all adjusted design(voom-normalized)',isKeyPlot=TRUE)
```

```{r residualSigCovars, fig.width=20, fig.height=10}
residualSigCovars[["PC_res"]][[1]]$plotData
```

```{r residualSigCovars.ALL, fig.width=20, fig.height=10}
residualSigCovars[["PC_res"]][[2]]$plotData
```

Readjust for covariates, normalise and perform outlier analysis (as a sanity check)

```{r new.design, cache=TRUE}
# Find principal components of expression to plot
PC <- prcomp(scale(VOOM.ADJUSTED.GENE_EXPRESSION$E))

# Determine number of clusters automatically using pamk
pam.cluster <- pamk(t(VOOM.ADJUSTED.GENE_EXPRESSION$E), krange=2:10)

# Plot first 2 PCs
plotdata <- data.frame(UID=rownames(PC$rotation), PC1=PC$rotation[,1], PC2=PC$rotation[,2], cluster=pam.cluster$pamobject$clustering)
plotdata <- merge(plotdata, METADATA, by="UID")

p <- ggplot(plotdata, aes(x=PC1, y=PC2))
p <- p + geom_point(aes(color=factor(cluster), shape=Diffname_short, size=Gender))
p <- p + theme_bw() + scale_size_manual(values = c(5, 2)) + theme(legend.position="top") 
p
```

Store covariates, design matrix, and voom adjusted gene expression

```{r synapsestore,echo=FALSE}
if (SYNAPSE_STORE){  
  # Code
  CODE <- File('./CovariateAnalysis.Rmd',name = 'Covariate Analysis',parentId = parentId)
  CODE <- synStore(CODE, used = ALL_USED_IDs,activityName='Covariate Analysis', executed='https://github.com/th1vairam/pcbc_c4_analysis/blob/cov_anal/code/Rmd/CovariateAnalysis.Rmd')
  
  # Expression Data
  write.table(VOOM.ADJUSTED.GENE_EXPRESSION$E,file = './AdjustedExpression.tsv',sep='\t',row.names=T,col.names=T,quote=F)
  EXPRESSION <- File('./AdjustedExpression.tsv',name = 'Adjusted Expression',parentId = parentId)
  EXPRESSION <- synStore(EXPRESSION, used = ALL_USED_IDs, activityName='Covariate Analysis', executed=CODE$properties$id)  
  
  # Adjustment Weights 
  write.table(VOOM.ADJUSTED.GENE_EXPRESSION$weights,file = './AdjustedWeights.tsv',sep='\t',row.names=T,col.names=T,quote=F)
  WEIGHTS <- File('AdjustedWeights.tsv',name = 'Adjusted Weights',parentId = parentId)
  WEIGHTS <- synStore(WEIGHTS, used = ALL_USED_IDs, activityName='Covariate Analysis', executed=CODE$properties$id)
  
  # Design Matrix
  write.table(VOOM.ADJUSTED.GENE_EXPRESSION$design,file = './AdjustedDesign.tsv',sep='\t',row.names=T,col.names=T,quote=F)
  DESIGN <- File('AdjustedDesign.tsv',name = 'Adjusted Design',parentId = parentId)
  DESIGN <- synStore(DESIGN, used = ALL_USED_IDs, activityName='Covariate Analysis', executed=CODE$properties$id)
}
```